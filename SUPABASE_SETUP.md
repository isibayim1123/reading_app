# Supabaseã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰

ã“ã®ã‚¬ã‚¤ãƒ‰ã§ã¯ã€Reading Appã§ä½¿ç”¨ã™ã‚‹Supabaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †ã‚’èª¬æ˜ã—ã¾ã™ã€‚

## ğŸ“‹ ç›®æ¬¡

1. [Supabaseã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ](#1-supabaseã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ)
2. [æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ](#2-æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ)
3. [ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ](#3-ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ)
4. [ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒã‚±ãƒƒãƒˆä½œæˆ](#4-ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒã‚±ãƒƒãƒˆä½œæˆ)
5. [ç’°å¢ƒå¤‰æ•°ã®è¨­å®š](#5-ç’°å¢ƒå¤‰æ•°ã®è¨­å®š)
6. [å‹•ä½œç¢ºèª](#6-å‹•ä½œç¢ºèª)

---

## 1. Supabaseã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ

1. [Supabaseå…¬å¼ã‚µã‚¤ãƒˆ](https://supabase.com/)ã«ã‚¢ã‚¯ã‚»ã‚¹
2. å³ä¸Šã®ã€ŒStart your projectã€ã‚’ã‚¯ãƒªãƒƒã‚¯
3. GitHubã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³ï¼ˆæ¨å¥¨ï¼‰
   - ã¾ãŸã¯ã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ç™»éŒ²

## 2. æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ

### 2.1 ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ

1. ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ã€ŒNew Projectã€ã‚’ã‚¯ãƒªãƒƒã‚¯
2. ä»¥ä¸‹ã®æƒ…å ±ã‚’å…¥åŠ›ï¼š
   - **Name**: `reading-app` (ä»»æ„ã®åå‰)
   - **Database Password**: å¼·åŠ›ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç”Ÿæˆãƒ»ä¿å­˜
   - **Region**: `Northeast Asia (Tokyo)` (æ—¥æœ¬å‘ã‘ã®å ´åˆ)
   - **Pricing Plan**: `Free` (é–‹ç™ºãƒ»ãƒ†ã‚¹ãƒˆç”¨)

3. ã€ŒCreate new projectã€ã‚’ã‚¯ãƒªãƒƒã‚¯
4. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æº–å‚™å®Œäº†ã¾ã§æ•°åˆ†å¾…ã¤

### 2.2 ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã®ç¢ºèª

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒä½œæˆã•ã‚ŒãŸã‚‰ã€ä»¥ä¸‹ã®æƒ…å ±ã‚’ç¢ºèªãƒ»ã‚³ãƒ”ãƒ¼ã—ã¾ã™ï¼š

1. å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®ã€ŒSettingsã€â†’ã€ŒAPIã€ã‚’é–‹ã
2. ä»¥ä¸‹ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãƒ¡ãƒ¢ï¼š
   - **Project URL** (ä¾‹: `https://xxxxxxxxxxxxx.supabase.co`)
   - **anon public** key (é•·ã„æ–‡å­—åˆ—)

## 3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ

### 3.1 SQL Editorã‚’é–‹ã

1. å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®ã€ŒSQL Editorã€ã‚’ã‚¯ãƒªãƒƒã‚¯
2. ã€Œ+ New queryã€ã‚’ã‚¯ãƒªãƒƒã‚¯

### 3.2 ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè¡Œ

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå†…ã®`supabase/migrations/`ã«ã‚ã‚‹4ã¤ã®SQLãƒ•ã‚¡ã‚¤ãƒ«ã‚’**é †ç•ªã«**å®Ÿè¡Œã—ã¾ã™ã€‚

#### ã‚¹ãƒ†ãƒƒãƒ—1: åˆæœŸã‚¹ã‚­ãƒ¼ãƒ

1. `supabase/migrations/00_initial_schema.sql`ã®å†…å®¹ã‚’ã‚³ãƒ”ãƒ¼
2. SQL Editorã«è²¼ã‚Šä»˜ã‘
3. å³ä¸‹ã®ã€ŒRunã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
4. ã€ŒSuccess. No rows returnedã€ã¨è¡¨ç¤ºã•ã‚Œã‚Œã°OK

#### ã‚¹ãƒ†ãƒƒãƒ—2: RLSãƒãƒªã‚·ãƒ¼

1. `supabase/migrations/01_rls_policies.sql`ã®å†…å®¹ã‚’ã‚³ãƒ”ãƒ¼
2. SQL Editorã«è²¼ã‚Šä»˜ã‘ï¼ˆæ–°ã—ã„ã‚¯ã‚¨ãƒªï¼‰
3. ã€ŒRunã€ã‚’ã‚¯ãƒªãƒƒã‚¯

#### ã‚¹ãƒ†ãƒƒãƒ—3: é–¢æ•°ã¨ãƒˆãƒªã‚¬ãƒ¼

1. `supabase/migrations/02_functions_triggers.sql`ã®å†…å®¹ã‚’ã‚³ãƒ”ãƒ¼
2. SQL Editorã«è²¼ã‚Šä»˜ã‘ï¼ˆæ–°ã—ã„ã‚¯ã‚¨ãƒªï¼‰
3. ã€ŒRunã€ã‚’ã‚¯ãƒªãƒƒã‚¯

#### ã‚¹ãƒ†ãƒƒãƒ—4: åˆæœŸãƒ‡ãƒ¼ã‚¿

1. `supabase/migrations/03_seed_data.sql`ã®å†…å®¹ã‚’ã‚³ãƒ”ãƒ¼
2. SQL Editorã«è²¼ã‚Šä»˜ã‘ï¼ˆæ–°ã—ã„ã‚¯ã‚¨ãƒªï¼‰
3. ã€ŒRunã€ã‚’ã‚¯ãƒªãƒƒã‚¯

### 3.3 å‹•ä½œç¢ºèª

1. å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®ã€ŒTable Editorã€ã‚’ã‚¯ãƒªãƒƒã‚¯
2. ä»¥ä¸‹ã®ãƒ†ãƒ¼ãƒ–ãƒ«ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªï¼š
   - profiles
   - classes
   - contents
   - practice_records
   - difficult_words
   - badges
   - user_badges
   - milestones
   - favorites

3. `badges`ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’é–‹ã„ã¦ã€17å€‹ã®ãƒãƒƒã‚¸ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
4. `contents`ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’é–‹ã„ã¦ã€ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª

## 4. ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒã‚±ãƒƒãƒˆä½œæˆ

éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚„ã‚¢ãƒã‚¿ãƒ¼ç”»åƒã‚’ä¿å­˜ã™ã‚‹ãŸã‚ã®ãƒã‚±ãƒƒãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚

### 4.1 ãƒã‚±ãƒƒãƒˆã®ä½œæˆ

1. å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®ã€ŒStorageã€ã‚’ã‚¯ãƒªãƒƒã‚¯
2. ã€ŒCreate a new bucketã€ã‚’ã‚¯ãƒªãƒƒã‚¯

#### ãƒã‚±ãƒƒãƒˆ1: audio-samplesï¼ˆãŠæ‰‹æœ¬éŸ³å£°ï¼‰

1. **Name**: `audio-samples`
2. **Public bucket**: âœ… ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã‚‹
3. ã€ŒCreate bucketã€ã‚’ã‚¯ãƒªãƒƒã‚¯

#### ãƒã‚±ãƒƒãƒˆ2: user-recordingsï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼éŒ²éŸ³ï¼‰

1. ã€ŒCreate a new bucketã€ã‚’ã‚¯ãƒªãƒƒã‚¯
2. **Name**: `user-recordings`
3. **Public bucket**: âŒ ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã™ï¼ˆãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆï¼‰
4. ã€ŒCreate bucketã€ã‚’ã‚¯ãƒªãƒƒã‚¯

#### ãƒã‚±ãƒƒãƒˆ3: avatarsï¼ˆãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒï¼‰

1. ã€ŒCreate a new bucketã€ã‚’ã‚¯ãƒªãƒƒã‚¯
2. **Name**: `avatars`
3. **Public bucket**: âœ… ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã‚‹
4. ã€ŒCreate bucketã€ã‚’ã‚¯ãƒªãƒƒã‚¯

### 4.2 ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒãƒªã‚·ãƒ¼ã®è¨­å®š

å„ãƒã‚±ãƒƒãƒˆã«é©åˆ‡ãªã‚¢ã‚¯ã‚»ã‚¹ãƒãƒªã‚·ãƒ¼ã‚’è¨­å®šã—ã¾ã™ã€‚

#### audio-samples ã®ãƒãƒªã‚·ãƒ¼

1. `audio-samples`ãƒã‚±ãƒƒãƒˆã‚’é¸æŠ
2. ã€ŒPoliciesã€ã‚¿ãƒ–ã‚’ã‚¯ãƒªãƒƒã‚¯
3. ã€ŒNew Policyã€â†’ã€ŒFor full customizationã€ã‚’é¸æŠ
4. ä»¥ä¸‹ã®ãƒãƒªã‚·ãƒ¼ã‚’è¿½åŠ ï¼š

**SELECT Policyï¼ˆèª°ã§ã‚‚èª­ã¿å–ã‚Šå¯èƒ½ï¼‰:**
```sql
Policy name: Public can view audio samples
Allowed operation: SELECT
Target roles: public

USING expression:
bucket_id = 'audio-samples'
```

**INSERT Policyï¼ˆå…ˆç”Ÿã®ã¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼‰:**
```sql
Policy name: Teachers can upload audio samples
Allowed operation: INSERT
Target roles: authenticated

WITH CHECK expression:
bucket_id = 'audio-samples'
AND auth.uid() IN (
  SELECT id FROM profiles WHERE user_type = 'teacher'
)
```

#### user-recordings ã®ãƒãƒªã‚·ãƒ¼

1. `user-recordings`ãƒã‚±ãƒƒãƒˆã‚’é¸æŠ
2. ã€ŒPoliciesã€ã‚¿ãƒ–ã‚’ã‚¯ãƒªãƒƒã‚¯
3. ä»¥ä¸‹ã®ãƒãƒªã‚·ãƒ¼ã‚’è¿½åŠ ï¼š

**SELECT Policyï¼ˆæœ¬äººã®ã¿ï¼‰:**
```sql
Policy name: Users can view own recordings
Allowed operation: SELECT
Target roles: authenticated

USING expression:
bucket_id = 'user-recordings'
AND (storage.foldername(name))[1] = auth.uid()::text
```

**INSERT Policyï¼ˆæœ¬äººã®ã¿ï¼‰:**
```sql
Policy name: Users can upload own recordings
Allowed operation: INSERT
Target roles: authenticated

WITH CHECK expression:
bucket_id = 'user-recordings'
AND (storage.foldername(name))[1] = auth.uid()::text
```

#### avatars ã®ãƒãƒªã‚·ãƒ¼

1. `avatars`ãƒã‚±ãƒƒãƒˆã‚’é¸æŠ
2. ã€ŒPoliciesã€ã‚¿ãƒ–ã‚’ã‚¯ãƒªãƒƒã‚¯
3. ä»¥ä¸‹ã®ãƒãƒªã‚·ãƒ¼ã‚’è¿½åŠ ï¼š

**SELECT Policyï¼ˆèª°ã§ã‚‚èª­ã¿å–ã‚Šå¯èƒ½ï¼‰:**
```sql
Policy name: Public can view avatars
Allowed operation: SELECT
Target roles: public

USING expression:
bucket_id = 'avatars'
```

**INSERT/UPDATE Policyï¼ˆæœ¬äººã®ã¿ï¼‰:**
```sql
Policy name: Users can upload own avatar
Allowed operation: INSERT, UPDATE
Target roles: authenticated

WITH CHECK expression:
bucket_id = 'avatars'
AND name = auth.uid()::text || '.jpg'
```

## 5. ç’°å¢ƒå¤‰æ•°ã®è¨­å®š

### 5.1 .envãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§ï¼š

```bash
cp .env.example .env
```

### 5.2 Supabaseèªè¨¼æƒ…å ±ã®è¨­å®š

`.env`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã„ã¦ã€å…ˆã»ã©ã‚³ãƒ”ãƒ¼ã—ãŸæƒ…å ±ã‚’è²¼ã‚Šä»˜ã‘ã¾ã™ï¼š

```env
VITE_SUPABASE_URL=https://xxxxxxxxxxxxx.supabase.co
VITE_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...ï¼ˆé•·ã„æ–‡å­—åˆ—ï¼‰
```

## 6. å‹•ä½œç¢ºèª

### 6.1 ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®èµ·å‹•

```bash
# ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆåˆå›ã®ã¿ï¼‰
pnpm install

# é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•
pnpm dev
```

ãƒ–ãƒ©ã‚¦ã‚¶ã§ http://localhost:3000 ã‚’é–‹ãã¾ã™ã€‚

### 6.2 Supabaseæ¥ç¶šãƒ†ã‚¹ãƒˆ

SQL Editorã§ä»¥ä¸‹ã®ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã—ã¦ã€ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã‚‹ã“ã¨ã‚’ç¢ºèªï¼š

```sql
-- ãƒãƒƒã‚¸ã®ä¸€è¦§ã‚’å–å¾—
SELECT * FROM badges ORDER BY display_order;

-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ä¸€è¦§ã‚’å–å¾—
SELECT id, title, difficulty_level, category FROM contents WHERE is_published = true;
```

## ğŸ‰ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†ï¼

ã“ã‚Œã§Supabaseã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸã€‚æ¬¡ã¯èªè¨¼æ©Ÿèƒ½ã®å®Ÿè£…ã«é€²ã¿ã¾ã—ã‚‡ã†ã€‚

---

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚¨ãƒ©ãƒ¼: "relation already exists"

æ—¢ã«ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã—ã¦ã„ã‚‹å ´åˆã®ã‚¨ãƒ©ãƒ¼ã§ã™ã€‚

**è§£æ±ºæ–¹æ³•**:
1. Table Editorã§æ—¢å­˜ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å‰Šé™¤
2. ã¾ãŸã¯ã€SQL Editorã§ä»¥ä¸‹ã‚’å®Ÿè¡Œï¼š
```sql
DROP SCHEMA public CASCADE;
CREATE SCHEMA public;
GRANT ALL ON SCHEMA public TO postgres;
GRANT ALL ON SCHEMA public TO public;
```
3. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†å®Ÿè¡Œ

### ã‚¨ãƒ©ãƒ¼: "permission denied"

RLSãƒãƒªã‚·ãƒ¼ã®å•é¡Œã§ã™ã€‚

**è§£æ±ºæ–¹æ³•**:
1. SQL Editorã§ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¦RLSã®çŠ¶æ…‹ã‚’ç¢ºèªï¼š
```sql
SELECT schemaname, tablename, rowsecurity
FROM pg_tables
WHERE schemaname = 'public';
```

2. å¿…è¦ã«å¿œã˜ã¦`01_rls_policies.sql`ã‚’å†å®Ÿè¡Œ

### ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒé€”ä¸­ã§å¤±æ•—ã™ã‚‹

**è§£æ±ºæ–¹æ³•**:
1. ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚ˆãèª­ã‚€
2. è©²å½“ã™ã‚‹ç®‡æ‰€ã‚’ä¿®æ­£
3. å¤±æ•—ã—ãŸç®‡æ‰€ã‹ã‚‰å†å®Ÿè¡Œ

### ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒãƒªã‚·ãƒ¼ãŒé©ç”¨ã•ã‚Œãªã„

**è§£æ±ºæ–¹æ³•**:
1. Storageã®ã€ŒConfigurationã€ã‚¿ãƒ–ã‚’ç¢ºèª
2. RLSãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹ã‹ç¢ºèª
3. ãƒãƒªã‚·ãƒ¼ã®æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯

---

## å‚è€ƒãƒªãƒ³ã‚¯

- [Supabaseå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://supabase.com/docs)
- [Supabase Auth ã‚¬ã‚¤ãƒ‰](https://supabase.com/docs/guides/auth)
- [Supabase Storage ã‚¬ã‚¤ãƒ‰](https://supabase.com/docs/guides/storage)
- [Row Level Security](https://supabase.com/docs/guides/auth/row-level-security)

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

- [ ] èªè¨¼æ©Ÿèƒ½ã®å®Ÿè£…
- [ ] ãƒ­ã‚°ã‚¤ãƒ³/ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ãƒšãƒ¼ã‚¸ã®ä½œæˆ
- [ ] ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®å®Ÿè£…
- [ ] ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ä¸€è¦§ã®å®Ÿè£…
